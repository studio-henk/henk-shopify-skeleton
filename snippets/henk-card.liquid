{% comment %} {{ collection | json }} {% endcomment %}
{% comment %} {{ product | json }} {% endcomment %}
{% comment %} {{ product.tags | json }} {% endcomment %}

{% assign show_variant_image_on_card = false %}
{% comment %} {% assign show_variant_mf_color_on_card = true %} {% endcomment %}
{% assign show_variant_mf_color_on_card = false %}
{% comment %} {% assign show_variant_mf_image_on_card = false %} {% endcomment %}
{% assign show_variant_mf_image_on_card = true %}

{% assign card_url = product.url %}
{% if variant %}
  {% assign card_url = product.url | append: '?variant=' | append: variant.id %}
{% endif %}

<div class="henk-card {% if card_variant %} henk-card--{{ card_variant }}{% endif %}" data-base-url="{{ product.url }}">
  <a
    href="{{ card_url }}"
    class="henk-card__image-link"
    id="image-link-{{ product.id }}"
  >
    <figure class="henk-card__image-container">
      {% assign img = variant.featured_image | default: product.featured_image %}
      {% if img %}
        <img
          id="card-{{ product.id }}"
          class="henk-card__img"
          src="{{ img | image_url: width: 1134 }}"
          alt="{{ img.alt | default: product.title }}"
          width="1134"
          height="1134"
        >
      {% else %}
        {{ 'image' | placeholder_svg_tag }}
      {% endif %}
    </figure>
  </a>
  {% if show_variants_on_card and card_variant == null %}
    <div class="henk-card__variant-selector">
      {% if product.variants.size > 1 %}
        {% assign max_variants = 5 %}
        {% assign first_variant = product.variants.first %}
        {% for variant in product.variants limit: max_variants %}
          {% if variant.featured_image %}
            {%- comment -%}:SWATCH{%- endcomment -%}
            <a
              href="{{ product.url }}?variant={{ variant.id }}"
              class="henk-card__variant-swatch {% if variant.id == first_variant.id %}is-active{% endif %}"
              data-main-id="card-{{ product.id }}"
              data-subtitle-id="subtitle-{{ product.id }}"
              data-variant-img="{{ variant.featured_image | image_url: width: 1134 }}"
              data-variant-title="{{ variant.title }}"
              data-variant-id="{{ variant.id }}"
              data-variant-price="{{ variant.price | money_without_trailing_zeros }}"
            >
              <img
                src="{{ variant.featured_image | image_url: width: 44, height: 44 }}"
                alt="{{ variant.title }}"
                width="44"
                height="44"
              >
            </a>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  {% endif %}
  <div class="henk-card__content">
    <p class="henk-card__title truncate">{{ product.title }}</p>

    {% if card_variant == null %}
      {% if variant %}
        <p class="henk-card__subtitle" id="subtitle-{{ product.id }}">{{ variant.title }}</p>
      {% else %}
        <p class="henk-card__subtitle">???</p>
      {% endif %}
    {% endif %}

    {% if card_variant == null %}
      {% if product.metafields.custom.short_description != blank %}
        <p
          class="henk-card__description truncate"
          title="{{ product.metafields.custom.short_description }}"
        >
          {{ product.metafields.custom.short_description }}
        </p>
      {% endif %}
    {% else %}
      <p class="henk-card__price">
        {%- if product.price_varies -%}
          {{ 'card.from_label' | t }}
          <span class="henk-card__price-number">{{ product.price_min | money_without_trailing_zeros }}</span>
        {%- else -%}
          {{ product.price | money_without_trailing_zeros }}
        {%- endif -%}
      </p>
    {% endif %}

    {% if card_variant == null %}
      {% assign min_price = product.price_min | money_without_trailing_zeros %}

      {% if product.price_varies %}
        {% assign price_label = 'card.from_label' | t | append: ' ' | append: min_price %}
      {% else %}
        {% assign price_label = product.price | money_without_trailing_zeros %}
      {% endif %}

      {% render 'henk-button',
        element: 'a',
        href: card_url,
        label: price_label,
        extra_classes: 'henk-card__button',
        id: 'price-link-#{product.id}'
      %}
    {% endif %}
  </div>

  {% comment %} NOTE: variant selector {% endcomment %}
  {% if show_variants_on_card and card_variant == 'macs' %}
    <div class="henk-card__variant-selector">
      {% if product.variants.size > 1 %}
        {% assign max_variants = 5 %}
        {% assign first_variant = product.variants.first %}
        {% for variant in product.variants limit: max_variants | sort: 'title' %}
          {%- comment -%}
            NOTE: we want the first option (Fabric?) and its color
            value
          {%- endcomment -%}
          {% comment %} {{ variant.product.options_with_values | json }} {% endcomment %}
          {% comment %} {{ variant.product.metafields.HENK.material.value | json }} {% endcomment %}
          {% comment %} {{ variant.metafields.HENK.material.value | json }} {% endcomment %}
          {% comment %} {{ variant | json }} {% endcomment %}
          {% comment %} {{ variant.metafields.HENK | json }} {% endcomment %}

          {% assign first_metafield_value = '' %}
          {% for kv in variant.metafields.HENK %}
            {% assign first_metafield_value = kv[1].value %}
            {% break %}
          {% endfor %}

          {% comment %} {{ first_metafield_value | json }} {% endcomment %}
          {% comment %} {{ first_metafield_value.color }} {% endcomment %}

          {%- comment -%}show color code swatch {%- endcomment -%}
          {% if first_metafield_value.color and show_variant_mf_color_on_card %}
            <a
              href="{{ product.url }}?variant={{ variant.id }}"
              class="henk-card__variant-swatch {% if variant.id == first_variant.id %}is-active{% endif %}"
              title="{{ variant.title }}"
              data-main-id="card-{{ product.id }}"
              data-subtitle-id="subtitle-{{ product.id }}"
              data-variant-img="{{ variant.featured_image | image_url: width: 1134 }}"
              data-variant-title="{{ variant.title }}"
              data-variant-id="{{ variant.id }}"
              data-variant-price="{{ variant.price | money_without_trailing_zeros }}"
            >
              <span
                class="custom-swatch"
                style="
                  background-color: {{
                  first_metafield_value.color }};
                "
              >
                <span class="visually-hidden">{{ variant.title }}</span>
              </span>
            </a>
          {% endif %}

          {% comment %} {{ first_metafield_value.swatch | json }} {% endcomment %}
          {% assign swatch_image = first_metafield_value.swatch | image_url: '44x44' %}

          {%- comment -%}show image from metafield swatch {%- endcomment -%}

          {% if first_metafield_value.color and show_variant_mf_image_on_card %}
            <a
              href="{{ product.url }}?variant={{ variant.id }}"
              class="henk-card__variant-swatch {% if variant.id == first_variant.id %}is-active{% endif %}"
              title="{{ variant.title }}"
              data-main-id="card-{{ product.id }}"
              data-subtitle-id="subtitle-{{ product.id }}"
              data-variant-img="{{ variant.featured_image | image_url: width: 1134 }}"
              data-variant-title="{{ variant.title }}"
              data-variant-id="{{ variant.id }}"
              data-variant-price="{{ variant.price | money_without_trailing_zeros }}"
            >
              <span
                class="custom-swatch"
                style="
                  background-color: {{
                  first_metafield_value.color }};
                "
              >
                <span class="visually-hidden">{{ variant.title }}</span>
                <img
                  src="{{ swatch_image | image_url: width: 44, height: 44 }}"
                  alt="{{ variant.title }}"
                  width="44"
                  height="44"
                >
              </span>
            </a>
          {% endif %}

          {% if variant.featured_image and show_variant_image_on_card %}
            <a
              href="{{ product.url }}?variant={{ variant.id }}"
              class="henk-card__variant-swatch {% if variant.id == first_variant.id %}is-active{% endif %}"
              title="{{ variant.title }}"
              data-main-id="card-{{ product.id }}"
              data-subtitle-id="subtitle-{{ product.id }}"
              data-variant-img="{{ variant.featured_image | image_url: width: 1134 }}"
              data-variant-title="{{ variant.title }}"
              data-variant-id="{{ variant.id }}"
              data-variant-price="{{ variant.price | money_without_trailing_zeros }}"
            >
              <img
                src="{{ variant.featured_image | image_url: width: 44, height: 44 }}"
                alt="{{ variant.title }}"
                width="44"
                height="44"
              >
            </a>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  {% endif %}

  {% if product.tags != blank %}
    <div class="henk-card__tags">
      {% for tag in product.tags limit: 1 %}
        {% render 'henk-tag', tag: tag %}
      {% endfor %}
    </div>
  {% endif %}
</div>
<style>
  .henk-card__variant-selector {
    display: flex;
    gap: 8px;
  }

  .henk-card__variant-swatch {
    border-radius: 100%;
    aspect-ratio: 1 / 1;
    border: 1px solid transparent;

    .custom-swatch {
      width: 44px;
      height: 44px;
      display: block;
      border-radius: 100%;
    }
  }

  .henk-card__variant-swatch.is-active {
    border: 1px solid black;
  }

  .henk-card__variant-swatch img {
    margin-bottom: 0;
    border-radius: 100%;
    aspect-ratio: 1 / 1;
  }

  .henk-card--macs .henk-card__variant-selector {
    justify-self: flex-start;
    width: 100%;
  }
</style>
