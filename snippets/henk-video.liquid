{%- comment -%}
  henk-video.liquid
  Props:
    id: string (optional)
    src: string (required)
    poster: string (optional)
    autoplay: boolean (default: false)
    has_audio: boolean (default: false)
    loop: boolean (default: true)
    cover: boolean (default: false)
    rounded: boolean (default: false)
    description: string (optional)
    link: imageLink,
    link_target_blank: imageLinkTargetBlank
{%- endcomment -%}

{%- assign video_id = id | default: 'split-screen-video-' | append: media_obj.id | append: '-video' -%}

{%- comment -%} fallback poster if none provided {%- endcomment -%}
{% if poster %}
  yesssssss
  {% assign poster_url = poster | image_url %}
{% elsif src.preview_image %}
  {% assign poster_url = src.preview_image.src | image_url: width: 1200 %}
{% else %}
  {% assign poster_url = null %}
{% endif %}

<div
  id="{{ video_id }}"
  class="
    henk-video-container
    {% if cover %} henk-video-container--cover{% endif %}
    {% if rounded %} henk-video-container--rounded{% endif %}
  "
>
  {% if src.sources %}
    {% if link %}
      <a
        href="{{ link }}"
        {% if link_target_blank %}
          target="_blank" rel="noopener"
        {% endif %}
      >
        <video
          class="henk-video"
          {% if poster_url %}
            poster="{{ poster_url }}"
          {% endif %}
          {% if autoplay %}
            autoplay muted playsinline
          {% else %}
            controls
          {% endif %}
          {% if loop %}
            loop
          {% endif %}
          preload="auto"
          aria-label="{{ description | escape }}"
        >
          {% for source in src.sources %}
            <source src="{{ 'https:' | append: source.url }}" type="{{ source.mime_type }}">
          {% endfor %}
        </video>
      </a>
    {% else %}
      <video
        class="henk-video"
        {% if poster_url %}
          poster="{{ poster }}"
        {% endif %}
        {% if autoplay %}
          autoplay muted playsinline
        {% else %}
          controls
        {% endif %}
        {% if loop %}
          loop
        {% endif %}
        preload="auto"
        aria-label="{{ description | escape }}"
      >
        {% for source in src.sources %}
          <source src="{{ 'https:' | append: source.url }}" type="{{ source.mime_type }}">
        {% endfor %}
      </video>
    {% endif %}
  {% else %}
    {% if link %}
      <a
        href="{{ link }}"
        {% if link_target_blank %}
          target="_blank" rel="noopener"
        {% endif %}
      >
        <video
          class="henk-video"
          src="{{ src }}"
          {% if poster_url %}
            poster="{{ poster_url }}"
          {% endif %}
          {% if autoplay %}
            autoplay muted playsinline
          {% else %}
            controls
          {% endif %}
          {% if loop %}
            loop
          {% endif %}
          preload="auto"
          aria-label="{{ description | escape }}"
        ></video>
      </a>
    {% else %}
      <video
        class="henk-video"
        src="{{ src }}"
        {% if poster_url %}
          poster="{{ poster_url }}"
        {% endif %}
        {% if autoplay %}
          autoplay muted playsinline
        {% else %}
          controls
        {% endif %}
        {% if loop %}
          loop
        {% endif %}
        preload="auto"
        aria-label="{{ description | escape }}"
      ></video>
    {% endif %}
  {% endif %}

  {% if has_audio %}
    <button
      type="button"
      class="henk-button henk-video-sound-toggle"
      aria-label="Toggle video sound"
    >
      <svg
        class="volume-x"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </svg>
      <svg
        class="volume-2"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    </button>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('{{ video_id | escape }}');
    if (!container) return;

    const video = container.querySelector('video');
    const button = container.querySelector('.henk-video-sound-toggle');
    const svgMuted = button?.querySelector('.volume-x');
    const svgPlaying = button?.querySelector('.volume-2');

    if (button && svgMuted && svgPlaying) {
      // Ensure initial state matches video muted property
      if (video.muted || video.autoplay) {
        svgMuted.style.display = 'block';
        svgPlaying.style.display = 'none';
      } else {
        svgMuted.style.display = 'none';
        svgPlaying.style.display = 'block';
      }

      button.addEventListener('click', () => {
        video.muted = !video.muted;
        if (video.muted) {
          svgMuted.style.display = 'block';
          svgPlaying.style.display = 'none';
        } else {
          svgMuted.style.display = 'none';
          svgPlaying.style.display = 'block';
        }
      });
    }

    // IntersectionObserver for autoplay/pause
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            if (video.autoplay) video.play().catch(() => {});
          } else {
            video.pause();
            if (button && svgMuted && svgPlaying) {
              video.muted = true;
              svgMuted.style.display = 'block';
              svgPlaying.style.display = 'none';
            }
          }
        });
      },
      { threshold: 0.3 },
    );

    observer.observe(video);
  });
</script>
