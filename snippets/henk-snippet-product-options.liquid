{% for option in product.options_with_values %}
  {%- comment -%}check if has swatch, if true, then is Color option metaobject {%- endcomment -%}
  {%- if option.values.first.swatch -%}
    {% assign has_metafield = false %}

    {% for v in product.variants %}
      {% if v.metafields.HENK != blank %}
        {% assign has_metafield = true %}
        {% break %}
      {% endif %}
    {% endfor %}

    {%- comment -%} if > 0, we want to override the Color swatch with a metafield  {%- endcomment -%}
    {% if has_metafield %}
      <!-- At least one variant has a metafield -->
      {% for variant in product.variants %}
        {% comment %} {{ variant.metafields.HENK | json }} {% endcomment %}
        {% for key in variant.metafields.HENK %}
          {% assign metafield_name = key[0] %}
          {% assign metafield_value = key[1].value %}
          {% assign option_name = metafield_value.name %}
          {% assign option_color = metafield_value.color %}
          {% assign option_swatch = metafield_value.swatch | image_url %}

          {{ metafield_name }}
          <input
            type="radio"
            name="option-{{ option_index }}"
            value="
              {{
              option_name }}
            "
          >
          {{- option_name }}
          <span class="custom-swatch" style="background-color: {{ option_color }}">
            <img
              src="{{ option_swatch }}"
              alt="{{ option_name }}"
              width="44"
              height="44"
            >
          </span>
        {% endfor %}
      {% endfor %}
    {% else %}
      <!-- No variants have a metafield -->
      {% render 'henk-snippet-option-color', option: option, current_variant: current_variant %}
    {% endif %}

  {% else %}
    no swatch
  {%- endif -%}

  {% case option.name %}
    {% when 'Upholstery material', 'Fabric' %}
      <fieldset class="henk-fieldset">
        <legend class="henk-legend">Upholstery material</legend>

        <div class="options__container">
          {% assign option_index = forloop.index0 %}
          <!-- index of current option (0-based) -->

          {% for value in option.values %}
            {% comment %}
              Find 1 variant whose value for this option matches the option value
            {% endcomment %}
            {% assign matched_variant = null %}

            {% for v in product.variants %}
              {% if v.options[option_index] == value.name %}
                {% assign matched_variant = v %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if matched_variant %}
              {% assign material_data = matched_variant.metafields.HENK.fabric.value %}
              {%- if material_data -%}
                {% assign swatch_name = material_data.name %}
                {% assign swatch_color = material_data.color %}
                {% assign swatch_gid = material_data.swatch %}
                {% assign swatch_image = swatch_gid | image_url %}
              {% else %}
                {% assign swatch_name = value.name %}
                {% assign swatch_color = '#f8f8f8' %}
                {% assign swatch_image = '/cdn/shop/files/no-image.png?v=1763713910' %}
              {%- endif -%}

              <div class="henk-labeled-input">
                <label class="henk-label">
                  <input
                    class="henk-radio"
                    type="radio"
                    name="id"
                    value="{{ value.variant.id }}"
                    title="{{ swatch_name }}"
                    data-featured-image="{{ matched_variant.featured_image | image_url: width: 1134 }}"
                    data-material-name="{{ swatch_name }}"
                    data-sku="{{ value.variant.sku }}"
                    data-price="{{ matched_variant.price }}"

                    {% if value.variant.id == current_variant.id %}
                      checked
                    {% endif %}
                  >

                  <span
                    class="custom-swatch"
                    style="background-color: {{ swatch_color }};"
                  >
                    <img
                      src="{{ swatch_image | image_url: '44x44' }}"
                      alt="{{ swatch_name }}"
                      width="44"
                      height="44"
                    >
                  </span>

                  <span class="visually-hidden">
                    {{ swatch_name }}
                  </span>
                </label>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </fieldset>
    {% when 'Frame afwerking' %}
      ???
      <fieldset class="henk-fieldset">
        <legend class="henk-legend">Frame afwerking</legend>

        <div class="options__container">
          {% assign seen_frames = '' | split: ',' %}

          {% for variant in product.variants %}
            {% assign frame_obj = variant.metafields.HENK.frame_finish.value %}
            {% comment %} {{ frame_obj | json }} {% endcomment %}

            {% if frame_obj %}
              {% assign is_new = true %}
              {% for seen_id in seen_frames %}
                {% if seen_id == frame_obj.id %}
                  {% assign is_new = false %}
                {% endif %}
              {% endfor %}

              {% if is_new %}
                {% comment %} add id to seen_frames using concat and split {% endcomment %}
                {% assign seen_frames = seen_frames | concat: frame_obj.id | split: ',' %}

                <div class="henk-labeled-input henk-labeled-input--dir-verticalx">
                  <label class="henk-label">
                    <input
                      class="henk-radio"
                      type="radio"
                      name="id"
                      value="{{ variant.id }}"
                      {% if variant.id == current_variant.id %}
                        checked
                      {% endif %}
                      {% unless variant.available %}
                        disabled
                      {% endunless %}
                    >

                    <span
                      class="custom-swatch"
                      style="background-image: url({{ frame_obj.swatch | image_url: '100x100' }});"
                    ></span>

                    <span class="visually-hidden">
                      {{ frame_obj.name | default: variant.option2 }}
                    </span>
                  </label>
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </fieldset>

    {% else %}
      <h1 style="color: red;">hello strange case?</h1>
      <!-- Default Shopify radios for all other options -->
  {% endcase %}
{% endfor %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- helpers (declare once) ---
    function formatPriceEUR(amountInCents) {
      // defensive parse
      const cents = Number(amountInCents);
      if (isNaN(cents)) return '';
      const euros = cents / 100;
      // format and remove trailing ",00"
      const formatted = new Intl.NumberFormat('nl-NL', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(euros);
      return formatted.replace(',00', '');
    }

    // --- cache elements ---
    const mainImage = document.getElementById('ProductFeaturedImage');
    const skuEl = document.getElementById('ProductSKU');
    const materialNameEl = document.getElementById('SelectedMaterial');
    const priceEl = document.getElementById('ProductPrice');

    // get all variant radio buttons (your class)
    const variantRadios = document.querySelectorAll('.henk-radio');

    if (!variantRadios.length) return;

    variantRadios.forEach((radio) => {
      radio.addEventListener('change', function () {
        if (!this.checked) return;

        // variant id
        const variantId = this.value;

        // image
        const imgUrl = this.dataset.featuredImage;
        if (imgUrl && mainImage) {
          // keep existing alt if provided on data-alt, otherwise leave as-is
          mainImage.src = imgUrl;
          if (this.dataset.featuredAlt) {
            mainImage.alt = this.dataset.featuredAlt;
          }
        }

        // SKU
        const sku = this.dataset.sku;
        if (skuEl) {
          skuEl.textContent = sku ? 'SKU: ' + sku : 'SKU: â€”';
        }

        // MATERIAL NAME (metafield friendly)
        const materialName = this.dataset.materialName || this.dataset.materialname || '';
        if (materialNameEl) {
          materialNameEl.textContent = materialName || '';
        }

        // PRICE
        const price = this.dataset.price; // expected in cents (integer)
        if (priceEl) {
          const formatted = formatPriceEUR(price);
          if (formatted) {
            priceEl.textContent = formatted;
          }
        }

        // update browser URL without reload
        try {
          const url = new URL(window.location.href);
          url.searchParams.set('variant', variantId);
          window.history.replaceState({}, '', url);
        } catch (e) {
          // fallback for older browsers
          // no-op
        }
      });
    });
  });
</script>
