{{ current_variant.id | json }}
{% comment %} {{ product.metafields | json }} {% endcomment %}
{% comment %} {{ product.options | json }} {% endcomment %}
{% comment %} {{ product.options_by_name | json }} {% endcomment %}

{% comment %} {% for key in product.metafields.HENK %} {% endcomment %}
{% comment %}   {{ key }}: {{ product.metafields.HENK[key].value }} {% endcomment %}
{% comment %} {% endfor %} {% endcomment %}
{% comment %}{% endcomment %}
{% comment %} {% for key in current_variant.metafields.HENK %} {% endcomment %}
{% comment %}   {{ key }}: {{ current_variant.metafields.HENK[key].value }} {% endcomment %}
{% comment %} {% endfor %} {% endcomment %}

{% comment %}
    Loop through all variants of the product
    Show:
      - variant.id
      - variant title
      - built-in options (Color, Size, etc.)
      - any metafields in HENK namespace
  {% comment %} {% endcomment %}
{% endcomment %}
{% comment %}{% endcomment %}
{% comment %} {% for variant in product.variants %} {% endcomment %}
{% comment %}   <h3>Variant: {{ variant.title }} (ID: {{ variant.id }})</h3> {% endcomment %}
{% comment %}{% endcomment %}
{% comment %}   <ul> {% endcomment %}
{% comment %}     {% for i in (1..3) %} {% endcomment %}
{% comment %}       {% comment %} {% assign option_value = variant["option" | append: i ] %} {% endcomment %} {% endcomment %}
{% comment %}       {% assign option_key = 'option' | append: i %} {% endcomment %}
{% comment %}       {% assign option_value = variant[option_key] %} {% endcomment %}
{% comment %}       {% if option_value %} {% endcomment %}
{% comment %}         <li>Option {{ i }}: {{ option_value }}</li> {% endcomment %}
{% comment %}       {% endif %} {% endcomment %}
{% comment %}     {% endfor %} {% endcomment %}
{% comment %}{% endcomment %}
{% comment %}     {% for key in variant.metafields.HENK %} {% endcomment %}
{% comment %}       {% assign mf = variant.metafields.HENK[key] %} {% endcomment %}
{% comment %}       <li> {% endcomment %}
{% comment %}         Metafield {{ key }}: {% endcomment %}
{% comment %}         {% if mf.value %} {% endcomment %}
{% comment %}           {{ mf.value | json }} {% endcomment %}
{% comment %}         {% else %} {% endcomment %}
{% comment %}           empty {% endcomment %}
{% comment %}         {% endif %} {% endcomment %}
{% comment %}       </li> {% endcomment %}
{% comment %}     {% endfor %} {% endcomment %}
{% comment %}   </ul> {% endcomment %}
{% comment %} {% endfor %} {% endcomment %}

<input type="hidden" name="id" id="SelectedVariantId" value="{{ current_variant.id }}">
{% for option in product.options_with_values %}
  {% assign option_index = forloop.index0 %}

  {% comment %} {{ option | json }} {% endcomment %}

  {% case option.name %}
    {% when 'Color' %}
      <fieldset class="henk-fieldset">
        <legend class="henk-legend">Color</legend>
        <div class="options__container">
          {% for value in option.values %}
            {% assign matched_variant = null %}
            {% for v in product.variants %}
              {% if v.options[option_index] == value.name %}
                {% assign matched_variant = v %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if matched_variant %}
              <div class="henk-labeled-input">
                <label class="henk-label">
                  <input
                    class="henk-radio"
                    type="radio"
                    name="option-{{ option_index }}"
                    value="{{ value.name }}"
                    {% if current_variant.options[option_index] == value.name %}
                      checked
                    {% endif %}
                    data-featured-image="{{ matched_variant.featured_image | image_url: width: 1134 }}"
                    data-sku="{{ matched_variant.sku }}"
                    data-price="{{ matched_variant.price }}"
                  >
                  <span class="custom-swatch" style="background-color: {{ value.swatch.color }};"></span>
                  <span class="visually-hidden">{{ value.name }}</span>
                </label>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </fieldset>

    {% when 'Upholstery material' %}
      <fieldset class="henk-fieldset">
        <legend class="henk-legend">{{ option.name }}</legend>
        <div class="options__container">
          <!-- {% assign option_index = forloop.index0 %} -->
          {% for value in option.values %}
            {% assign matched_variant = null %}
            {% for v in product.variants %}
              {% if v.options[option_index] == value.name %}
                {% assign matched_variant = v %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if matched_variant %}
              {% assign material_data = matched_variant.metafields.HENK.material.value | first %}
              {% comment %} {{ material_data | json }} {% endcomment %}
              {% assign swatch_gid = material_data.swatch %}
              {% assign swatch_image = swatch_gid | image_url %}

              <div class="henk-labeled-input">
                <label class="henk-label">
                  <input
                    class="henk-radio"
                    type="radio"
                    name="option-{{ option_index }}"
                    value="{{ value.name }}"
                    title="{{ material_data.name }}"
                    data-featured-image="{{ matched_variant.featured_image | image_url: width: 1134 }}"
                    data-material-name="{{ material_data.name }}"
                    data-sku="{{ matched_variant.sku }}"
                    data-price="{{ matched_variant.price }}"
                    {% if current_variant.options[option_index] == value.name %}
                      checked
                    {% endif %}
                  >
                  <span class="custom-swatch" style="background-color: {{ material_data.color }};">
                    <img
                      src="{{ swatch_image | image_url: width: 44, height: 44 }}"
                      alt="{{ material_data.name }}"
                      width="44"
                      height="44"
                    >
                  </span>
                  <span class="visually-hidden">{{ material_data.name }}</span>
                </label>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </fieldset>

    {% when 'Frame afwerking' %}
      <fieldset class="henk-fieldset">
        <legend class="henk-legend">{{ option.name }}</legend>
        <div class="options__container">
          {% assign selected_options = current_variant.options %}
          {% assign option_index = forloop.index0 %}

          {% for value in option.values %}
            {% assign matched_variant = null %}
            {% for v in product.variants %}
              {% assign matches = true %}
              {% for i in (0..v.options['size-1']) %}
                {% if i == option_index %}
                  {% assign expected = value.name %}
                {% else %}
                  {% assign expected = selected_options[i] %}
                {% endif %}
                {% if v.options[i] != expected %}
                  {% assign matches = false %}
                  {% break %}
                {% endif %}
              {% endfor %}
              {% if matches %}
                {% assign matched_variant = v %}
                {% break %}
              {% endif %}
            {% endfor %}

            {% if matched_variant %}
              <div class="henk-labeled-input">
                <label class="henk-label">
                  <input
                    class="henk-radio"
                    type="radio"
                    name="option-{{ option_index }}"
                    value="{{ value.name }}"
                    title="{{ value.name }}"
                    data-featured-image="{{ matched_variant.featured_image | image_url: width: 1134 }}"
                    data-sku="{{ matched_variant.sku }}"
                    data-price="{{ matched_variant.price }}"
                    data-option-index="{{ option_index }}"
                    {% if current_variant.options[option_index] == value.name %}
                      checked
                    {% endif %}
                  >
                  <span
                    class="custom-swatch"
                    style="background-color: {{ value.swatch.color }};"
                  ></span>
                  <span class="visually-hidden">{{ value.name }}</span>
                </label>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </fieldset>

    {% else %}
      <!-- Default radios for other options -->
      something else here?
  {% endcase %}
{% endfor %}
<script>
  document.addEventListener('DOMContentLoaded', function () {

    // --- helpers ---
    function formatPriceEUR(amountInCents) {
      const cents = Number(amountInCents);
      if (isNaN(cents)) return '';
      const euros = cents / 100;
      const formatted = new Intl.NumberFormat('nl-NL', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(euros);
      return formatted.replace(',00', '');
    }

    // --- cache elements ---
    const mainImage = document.getElementById('ProductFeaturedImage');
    const skuEl = document.getElementById('ProductSKU');
    const materialNameEl = document.getElementById('SelectedMaterial');
    const priceEl = document.getElementById('ProductPrice');

    // --- get all radios ---
    const variantRadios = document.querySelectorAll('.henk-radio');
    if (!variantRadios.length) return;

    // --- create current selections object ---
    const selectedOptions = {};
    variantRadios.forEach(radio => {
      const index = radio.dataset.optionIndex;
      if (radio.checked) selectedOptions[index] = radio.value;
    });

    // --- product variants JSON (from Liquid) ---
    const productVariants = {{ product.variants | json }};

    function findMatchingVariant() {
      return productVariants.find(v =>
        v.options.every((opt, i) => selectedOptions[i] === opt)
      );
    }

    function updateUI(variant) {
      if (!variant) return;

      // Main image
      if (mainImage && variant.featured_image && variant.featured_image.src) {
        mainImage.src = variant.featured_image.src;
        if (variant.featured_image.alt) mainImage.alt = variant.featured_image.alt;
      }

      // SKU
      if (skuEl) skuEl.textContent = variant.sku ? 'SKU: ' + variant.sku : 'SKU: â€”';

      // Material name (optional)
      if (materialNameEl) materialNameEl.textContent = variant.metafields?.HENK?.material?.value?.[0]?.name || '';

      // Price
      if (priceEl) priceEl.textContent = formatPriceEUR(variant.price);

      // URL
      const url = new URL(window.location.href);
      url.searchParams.set('variant', variant.id);
      window.history.replaceState({}, '', url);
    }

    // --- listen for changes ---
    variantRadios.forEach(radio => {
      radio.addEventListener('change', function () {
        const index = this.dataset.optionIndex;
        selectedOptions[index] = this.value;

        const matchedVariant = findMatchingVariant();
        updateUI(matchedVariant);
      });
    });

    // --- initial UI update ---
    const initialVariant = findMatchingVariant();
    updateUI(initialVariant);

  });
</script>
