{% assign first_variant = product.variants.first %}
{% assign current_variant = first_variant %}

<!-- <p>has metafields?: {{ current_variant.metafields.HENK.size | json }}</p> -->
<!-- <p>which metafields?: {{ current_variant.metafields.HENK | json }}</p> -->
<!-- <p>check has mf: {{ product.variants.first.metafields.HENK.size | json }}</p> -->
<!-- <p>check has mf: {{ product.variants.metafields.HENK.size | json }}</p> -->

{%- comment -%}
  Grab metafield keys and values in order, and turn them into arrays.
  This works in Shopify because capturing strings + splitting does work.
{%- endcomment -%}

{% capture henk_keys %}
  {% for pair in current_variant.metafields.HENK %}
    {{ pair[0] }}|
  {% endfor %}
{% endcapture %}

{% capture henk_vals %}
  {% for pair in current_variant.metafields.HENK %}
    {{ pair[1] }}|
  {% endfor %}
{% endcapture %}

{% assign meta_keys = henk_keys | split: '|' %}
{% assign meta_vals = henk_vals | split: '|' %}

<!-- Options -->
{% for option in product.options_with_values %}
  {% assign option_index = forloop.index0 %}
  {% assign option_name = option.name | downcase | replace: ' ', '-' %}

  {% comment %}
    Get the metafield for this option index
    meta_vals[idx] is a reference to a metaobject
  {% endcomment %}
  {% assign metafield_ref = meta_vals[option_index] %}
  {% if metafield_ref %}
    {% comment %} {{ metafield_ref | json }} {% endcomment %}
    {% comment %} {% assign meta_obj = metafield_ref | metafield_text %} {% endcomment %}
    {% assign meta_obj = metafield_ref %}
  {% endif %}
  {% comment %} {% assign option_name = option.name | downcase | replace: ' ', '-' %} {% endcomment %}
  {% comment %} {{ meta_obj | json }} {% endcomment %}

  {% for key in meta_obj %}
    {% comment %} {% assign metafield_value = key[0].value %} {% endcomment %}
    {{ key.name }}
  {% endfor %}

  {% comment %} {{ metafield_value | json }} {% endcomment %}

  <fieldset class="henk-fieldsetx">
    <legend class="henk-legendx">{{ option.name }}</legend>

    <div class="options__container">
      {% for value in option.values %}
        {% assign is_color_swatch = value.swatch %}

        {%- comment -%}
          Determine label + swatch image:
          - If Color → use Shopify swatch
          - Else → use metafield assigned to this option index
        {%- endcomment -%}

        {% if is_color_swatch %}
          {% assign display_name = value %}
          {% assign swatch_img = value.swatch | image_url %}
          {% assign swatch_color = '' %}

        {% else %}
          {% if meta_obj %}
            {% comment %} {{ meta_obj | json }} {% endcomment %}
            {% assign display_name = meta_obj.name %}
            {% assign swatch_img = meta_obj.swatch | image_url: width: 64 %}
            {% assign swatch_color = meta_obj.color %}
          {% else %}
            {% assign display_name = value %}
            {% assign swatch_img = '' %}
            {% assign swatch_color = '' %}
          {% endif %}
        {% endif %}

        <div class="henk-labeled-inputx">
          <label class="henk-labelx">
            <input
              class="henk-radiox"
              type="radio"
              name="option-{{ option_name }}"
              value="{{ value }}"
              {% if current_variant.options[option_index] == value %}
                checked
              {% endif %}
            >

            <span
              class="custom-swatchx"
              {% if swatch_color %}
                style="background-color: {{ swatch_color }}"
              {% endif %}
            >
              {% if swatch_img %}
                <img src="{{ swatch_img }}" alt="{{ display_name }}" width="44" height="44">
              {% endif %}

              {{ display_name }}
            </span>
          </label>
        </div>
      {% endfor %}
    </div>
  </fieldset>
{% endfor %}

<hr>

<!-- Hidden input for form -->
<input type="hidden" name="id" id="SelectedVariantId" value="{{ current_variant.id }}">

<!-- Initial debug -->
<p>Current variant ID: {{ current_variant.id }}</p>
<p>Options: {{ current_variant.options | json }}</p>

{% for option in product.options_with_values %}
  {% assign option_index = forloop.index0 %}
  {% assign selected_options = current_variant.options %}

  <fieldset class="henk-fieldset">
    <legend class="henk-legend">{{ option.name }}</legend>
    <div class="options__container">
      {% for value in option.values %}
        {%- comment -%}
          STEP 1: Match the variant that corresponds to THIS option value
        {%- endcomment -%}

        {% assign matched_variant = null %}
        {% for v in product.variants %}
          {% assign matches = true %}

          {% for i in (0..v.options['size-1']) %}
            {% if i == option_index %}
              {% assign expected = value.name %}
            {% else %}
              {% assign expected = selected_options[i] %}
            {% endif %}

            {% if v.options[i] != expected %}
              {% assign matches = false %}
              {% break %}
            {% endif %}
          {% endfor %}

          {% if matches %}
            {% assign matched_variant = v %}
            {% break %}
          {% endif %}
        {% endfor %}

        {% if matched_variant %}
          {% comment %} {{ matched_variant | json }} {% endcomment %}
          {%- comment -%}
            STEP 2:
            Determine which metafield to use based on option.name.
            For each case, we assign the ACTUAL metafield object
            directly into "swatch_data".
          {%- endcomment -%}

          {% assign swatch_data = null %}
          {% case option.name %}
            {% when 'Color' %}
              {% assign swatch_data = value.swatch %}
            {% when 'Fabric' %}
              {% assign swatch_data = matched_variant.metafields.HENK.fabric.value %}
            {% when 'Upholstery material' %}
              {% assign swatch_data = matched_variant.metafields.HENK.fabric.value %}
            {% when 'Finish' %}
              {% comment %} {{ matched_variant.metafields.HENK.frame_finish.list? | json }} {% endcomment %}
              {% comment %} {{ matched_variant.metafields.HENK.frame_finish.type | json }} {% endcomment %}
              {% comment %} {{ matched_variant.metafields.HENK.frame_finish.value | json }} {% endcomment %}
              {% assign swatch_data = null %}
              {% assign finish_value = matched_variant.metafields.HENK.frame_finish.value %}
              {% comment %} {{ finish_value | json }} {% endcomment %}
              {% if finish_value %}
                {% assign swatch_data = finish_value %}
              {% endif %}
          {% endcase %}

          {% comment %} {{ swatch_data | json }} {% endcomment %}

          {%- comment -%}
            STEP 3 (FIXED):
            Reset swatch vars BEFORE assigning
          {%- endcomment -%}

          {% if swatch_data %}
            {% assign swatch_image = swatch_data.swatch | image_url %}
            {% assign swatch_color = swatch_data.color %}
            <div class="henk-labeled-input">
              <label class="henk-label">
                <input
                  class="henk-radio"
                  type="radio"
                  name="option-{{ option_index }}"
                  value="{{ value.name }}"
                  data-option-index="{{ option_index }}"
                  {% if current_variant.options[option_index] == value.name %}
                    checked
                  {% endif %}
                >

                <span
                  class="custom-swatch"
                  style="{% if swatch_color %}background-color: {{ swatch_color }};{% endif %}"
                >
                  {% if swatch_image %}
                    <img
                      src="{{ swatch_image | image_url: width: 44, height: 44 }}"
                      alt="{{ swatch_data.name }}"
                      width="44"
                      height="44"
                    >
                  {% endif %}
                </span>

                <span class="visually-hidden">
                  {{ swatch_data.name | default: value.name }}
                </span>
              </label>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </fieldset>
{% endfor %}
