{% comment %} {{ collection | json }} {% endcomment %}
{% comment %} {{ product | json }} {% endcomment %}
{% comment %} {{ product.tags | json }} {% endcomment %}

{% assign card_url = product.url %}
{% if variant %}
  {% assign card_url = product.url | append: '?variant=' | append: variant.id %}
{% endif %}

<div class="henk-card {% if card_variant %} henk-card--{{ card_variant }}{% endif %}" data-base-url="{{ product.url }}">
  <a
    href="{{ card_url }}"
    class="henk-card__image-link"
    id="image-link-{{ product.id }}"
  >
    <figure class="henk-card__image-container">
      {% assign img = variant.featured_image | default: product.featured_image %}
      {% if img %}
        <img
          id="card-{{ product.id }}"
          class="henk-card__img"
          src="{{ img | image_url: width: 1134 }}"
          alt="{{ img.alt | default: product.title }}"
          width="1134"
          height="1134"
        >
      {% else %}
        {{ 'image' | placeholder_svg_tag }}
      {% endif %}
    </figure>
  </a>
  {% if show_variants_on_card %}
    <div class="henk-card__variant-selector">
      {% if product.variants.size > 1 %}
        {% assign max_variants = 5 %}
        {% assign first_variant = product.variants.first %}
        {% for variant in product.variants limit: max_variants %}
          {% if variant.featured_image %}
            {%- comment -%}:SWATCH{%- endcomment -%}
            <a
              href="{{ product.url }}?variant={{ variant.id }}"
              class="henk-card__variant-swatch {% if variant.id == first_variant.id %}is-active{% endif %}"
              data-main-id="card-{{ product.id }}"
              data-subtitle-id="subtitle-{{ product.id }}"
              data-variant-img="{{ variant.featured_image | image_url: width: 1134 }}"
              data-variant-title="{{ variant.title }}"
              data-variant-id="{{ variant.id }}"
              data-variant-price="{% if product.price_varies %}{{ product.price_min | money_without_trailing_zeros }}{% else %}{{ product.price | money_without_trailing_zeros }}{% endif %}"
            >
              <img
                src="{{ variant.featured_image | image_url: width: 44, height: 44 }}"
                alt="{{ variant.title }}"
                width="44"
                height="44"
              >
            </a>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  {% endif %}
  <div class="henk-card__content">
    <p class="henk-card__title truncate">{{ product.title }}</p>

    {% if variant %}
      <p class="henk-card__subtitle" id="subtitle-{{ product.id }}">{{ variant.title }}</p>
    {% else %}
      <p class="henk-card__subtitle">???</p>
    {% endif %}

    {% if card_variant == null %}
      {% if product.metafields.custom.short_description != blank %}
        <p
          class="henk-card__description truncate"
          title="{{ product.metafields.custom.short_description }}"
        >
          {{ product.metafields.custom.short_description }}
        </p>
      {% endif %}
    {% else %}
      <p class="henk-card__price">
        {% if product.price_varies %}
          {{ 'card.from_label' | t }}
          {{ product.price_min | money_without_trailing_zeros }}
        {% else %}
          {{ product.price | money_without_trailing_zeros }}
        {% endif %}
      </p>
    {% endif %}

    {% if card_variant == null %}
      {% assign min_price = product.price_min | money_without_trailing_zeros %}

      {% if product.price_varies %}
        {% assign price_label = 'card.from_label' | t | append: ' ' | append: min_price %}
      {% else %}
        {% assign price_label = product.price | money_without_trailing_zeros %}
      {% endif %}

      {% render 'henk-button',
        element: 'a',
        href: card_url,
        label: price_label,
        extra_classes: 'henk-card__button',
        id: 'price-link-#{product.id}'
      %}
    {% endif %}
  </div>
  {% if product.tags != blank %}
    <div class="henk-card__tags">
      {% for tag in product.tags limit: 1 %}
        {% render 'henk-tag', tag: tag %}
      {% endfor %}
    </div>
  {% endif %}
</div>
<style>
  .henk-card__variant-selector {
    display: flex;
    gap: 8px;
  }

  .henk-card__variant-swatch {
    border-radius: 100%;
    aspect-ratio: 1 / 1;
    border: 1px solid transparent;
  }

  .henk-card__variant-swatch.is-active {
    border: 1px solid black;
  }

  .henk-card__variant-swatch img {
    margin-bottom: 0;
    border-radius: 100%;
    aspect-ratio: 1 / 1;
  }
</style>

<!-- <script> -->
<!-- document.addEventListener('DOMContentLoaded', function () { -->
<!-- document.querySelectorAll('.henk-card').forEach((card) => { -->
<!-- const imageLink = card.querySelector('.henk-card__image-link'); -->
<!-- const priceButton = card.querySelector('.henk-card__button'); -->
<!-- const mainImg = card.querySelector('.henk-card__img'); -->
<!-- const subtitle = card.querySelector('.henk-card__subtitle'); -->
<!-- const swatches = card.querySelectorAll('.henk-card__variant-swatch'); -->
<!--  -->
<!-- if (!imageLink || !priceButton || !mainImg || !subtitle || swatches.length === 0) return; -->
<!--  -->
<!-- // Set default active swatch on load -->
<!-- const activeSwatch = card.querySelector('.henk-card__variant-swatch.is-active') || swatches[0]; -->
<!-- const variantImg = activeSwatch.dataset.variantImg; -->
<!-- const variantTitle = activeSwatch.dataset.variantTitle; -->
<!-- const variantId = activeSwatch.dataset.variantId; -->
<!--  -->
<!-- mainImg.src = variantImg; -->
<!-- subtitle.textContent = variantTitle; -->
<!-- imageLink.href = `${card.dataset.baseUrl}?variant=${variantId}`; -->
<!-- priceButton.href = `${card.dataset.baseUrl}?variant=${variantId}`; -->
<!--  -->
<!-- // Hover behavior -->
<!-- swatches.forEach((swatch) => { -->
<!-- swatch.addEventListener('mouseenter', () => { -->
<!-- const variantImg = swatch.dataset.variantImg; -->
<!-- const variantTitle = swatch.dataset.variantTitle; -->
<!-- const variantId = swatch.dataset.variantId; -->
<!--  -->
<!-- mainImg.src = variantImg; -->
<!-- subtitle.textContent = variantTitle; -->
<!-- imageLink.href = `${card.dataset.baseUrl}?variant=${variantId}`; -->
<!-- priceButton.href = `${card.dataset.baseUrl}?variant=${variantId}`; -->
<!--  -->
<!-- swatches.forEach((s) => s.classList.remove('is-active')); -->
<!-- swatch.classList.add('is-active'); -->
<!-- }); -->
<!-- }); -->
<!-- }); -->
<!-- }); -->
<!-- </script> -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.henk-card').forEach((card) => {
      const imageLink = card.querySelector('.henk-card__image-link');
      const priceButton = card.querySelector('.henk-card__button');
      const mainImg = card.querySelector('.henk-card__img');
      const subtitle = card.querySelector('.henk-card__subtitle');
      const swatches = card.querySelectorAll('.henk-card__variant-swatch');

      if (!imageLink || !priceButton || !mainImg || !subtitle || swatches.length === 0) return;

      // Set default active swatch on load
      const activeSwatch = card.querySelector('.henk-card__variant-swatch.is-active') || swatches[0];
      mainImg.src = activeSwatch.dataset.variantImg;
      subtitle.textContent = activeSwatch.dataset.variantTitle;
      imageLink.href = `${card.dataset.baseUrl}?variant=${activeSwatch.dataset.variantId}`;
      priceButton.href = `${card.dataset.baseUrl}?variant=${activeSwatch.dataset.variantId}`;
      priceButton.textContent = activeSwatch.dataset.variantPrice;

      // Hover behavior
      swatches.forEach((swatch) => {
        swatch.addEventListener('mouseenter', () => {
          mainImg.src = swatch.dataset.variantImg;
          subtitle.textContent = swatch.dataset.variantTitle;
          imageLink.href = `${card.dataset.baseUrl}?variant=${swatch.dataset.variantId}`;
          priceButton.href = `${card.dataset.baseUrl}?variant=${swatch.dataset.variantId}`;
          priceButton.textContent = swatch.dataset.variantPrice;

          swatches.forEach((s) => s.classList.remove('is-active'));
          swatch.classList.add('is-active');
        });
      });
    });
  });
</script>
