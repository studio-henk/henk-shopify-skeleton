{%- comment -%}
  henk-video.liquid
  Props:
    id: string (optional)
    src: string (required)
    poster: string (optional)
    autoplay: boolean (default: false)
    loop: boolean (default: true)
    cover: boolean (default: false)
    rounded: boolean (default: false)
    description: string (optional)
    link: imageLink,
    link_target_blank: imageLinkTargetBlank
{%- endcomment -%}

{% comment %} {%- assign video_id = id | default: section.id | append: '-video' -%} {% endcomment %}

{%- assign video_id = id | default: 'split-screen-video-' | append: media_obj.id | append: '-video' -%}

{% comment %} {{ src | json }} {% endcomment %}
<div
  id="{{ video_id }}"
  class="
    henk-video-container
    {% if cover %} henk-video-container--cover{% endif %}
    {% if rounded %} henk-video-container--rounded{% endif %}
  "
>
  {% if src.sources %}
    {% if link %}
      <a
        href="{{ link }}"
        {% if link_target_blank %}
          target="_blank" rel="noopener"
        {% endif %}
      >
        <video
          class="henk-video"
          {% if poster %}
            poster="{{ poster }}"
          {% endif %}
          {% if autoplay %}
            autoplay muted playsinline
          {% else %}
            controls
          {% endif %}
          {% if loop %}
            loop
          {% endif %}
          preload="auto"
          aria-label="{{ description | escape }}"
        >
          {% for source in src.sources %}
            <source src="{{ 'https:' | append: source.url }}" type="{{ source.mime_type }}">
          {% endfor %}
        </video>
      </a>
    {% else %}
      <video
        class="henk-video"
        {% if poster %}
          poster="{{ poster }}"
        {% endif %}
        {% if autoplay %}
          autoplay muted playsinline
        {% else %}
          controls
        {% endif %}
        {% if loop %}
          loop
        {% endif %}
        preload="auto"
        aria-label="{{ description | escape }}"
      >
        {% for source in src.sources %}
          <source src="{{ 'https:' | append: source.url }}" type="{{ source.mime_type }}">
        {% endfor %}
      </video>
    {% endif %}
  {% else %}
    {% if link %}
      <a
        href="{{ link }}"
        {% if link_target_blank %}
          target="_blank" rel="noopener"
        {% endif %}
      >
        <video
          class="henk-video"
          src="{{ src }}"
          {% if poster %}
            poster="{{ poster }}"
          {% endif %}
          {% if autoplay %}
            autoplay muted playsinline
          {% else %}
            controls
          {% endif %}
          {% if loop %}
            loop
          {% endif %}
          preload="auto"
          aria-label="{{ description | escape }}"
        ></video>
      </a>
    {% else %}
      <video
        class="henk-video"
        src="{{ src }}"
        {% if poster %}
          poster="{{ poster }}"
        {% endif %}
        {% if autoplay %}
          autoplay muted playsinline
        {% else %}
          controls
        {% endif %}
        {% if loop %}
          loop
        {% endif %}
        preload="auto"
        aria-label="{{ description | escape }}"
      ></video>
    {% endif %}
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('{{ video_id | escape }}');
    if (!container) return;

    const video = container.querySelector('video');
    const button = container.querySelector('.henk-video-sound-toggle');
    const svgMuted = button?.querySelector('.volume-x');
    const svgPlaying = button?.querySelector('.volume-2');

    if (button && svgMuted && svgPlaying) {
      // Ensure initial state matches video muted property
      if (video.muted || video.autoplay) {
        svgMuted.style.display = 'block';
        svgPlaying.style.display = 'none';
      } else {
        svgMuted.style.display = 'none';
        svgPlaying.style.display = 'block';
      }

      button.addEventListener('click', () => {
        video.muted = !video.muted;
        if (video.muted) {
          svgMuted.style.display = 'block';
          svgPlaying.style.display = 'none';
        } else {
          svgMuted.style.display = 'none';
          svgPlaying.style.display = 'block';
        }
      });
    }

    // IntersectionObserver for autoplay/pause
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            if (video.autoplay) video.play().catch(() => {});
          } else {
            video.pause();
            if (button && svgMuted && svgPlaying) {
              video.muted = true;
              svgMuted.style.display = 'block';
              svgPlaying.style.display = 'none';
            }
          }
        });
      },
      { threshold: 0.3 },
    );

    observer.observe(video);
  });
</script>
