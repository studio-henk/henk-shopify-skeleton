{% comment %}
  Product template supporting:
  - Multi-option products with Shopify-style variant lookup
  - Unique swatches for Color, Upholstery material, Frame finish
  - Auto-updating featured image, price, SKU, material
  - Hidden variant ID input for Add to Cart
{% endcomment %}

<style>
  .product-images {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
  }
  .product-image {
    margin: 0;
  }
  .henk-input[name='quantity'] {
    display: none;
  }
  .product__title {
    margin-top: 0;
  }
  .options__container {
    display: flex;
    gap: 1rem;
  }
  .henk-label {
    position: relative;
  }
  .henk-radio {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    width: 44px;
    height: 44px;
    margin: 0;
  }
  .custom-swatch {
    display: block;
    width: 44px;
    height: 44px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  input[type='radio']:checked + .custom-swatch {
    border: 4px solid var(--color-blue-40);
  }
</style>

<section class="henk-section">
  <div class="henk-section__inner">
    <div class="henk-section__grid">
      <!-- LEFT: Media -->
      <div class="henk-section__grid-item">
        {% assign current_variant = product.selected_or_first_available_variant %}
        <figure class="henk-card__image-container">
          {% if current_variant.featured_image %}
            <img
              id="ProductFeaturedImage"
              class="henk-card__img"
              src="{{ current_variant.featured_image | image_url: width: 1134 }}"
              alt="{{ product.title }}"
              width="1134"
              height="1134"
            >
          {% else %}
            {{ 'image' | placeholder_svg_tag }}
          {% endif %}
        </figure>

        <h3>Gallery</h3>
        <div class="product-images">
          {% for image in product.images %}
            <img
              src="{{ image | image_url: width: 1200 }}"
              alt="{{ image.alt | escape | default: product.title }}"
              width="1200"
              height="1200"
              class="product-image"
              loading="lazy"
              {% if image.id %}
                data-image-id="{{ image.id }}"
              {% endif %}
            >
          {% endfor %}
        </div>
      </div>

      <!-- RIGHT: Info & Form -->
      <div class="henk-section__grid-item">
        <div class="product-info">
          {% assign display_title = current_variant.name | default: product.title %}
          <h1 class="product__title">{{ display_title }}</h1>

          {% assign current_material = current_variant.metafields.HENK.material.value | first %}
          {% if current_material %}
            <p id="SelectedMaterial" class="product__material">{{ current_material.name }}</p>
          {% endif %}

          <p id="ProductPrice" class="product__price">
            {{ current_variant.price | money_without_trailing_zeros }}
          </p>
          <p class="product__description">{{ product.description }}</p>
        </div>

        <div class="product-form">
          {% form 'product', product %}
            <!-- Hidden variant ID input -->
            <input type="hidden" name="id" id="SelectedVariantId" value="{{ current_variant.id }}">

            {% assign option_index = 0 %}
            {% for option in product.options_with_values %}
              <fieldset class="henk-fieldset">
                <legend class="henk-legend">{{ option.name }}</legend>
                <div class="options__container">
                  {% assign seen_values = '' | split: ',' %}
                  {% for variant in product.variants %}
                    {% assign value_obj = null %}
                    {% case option.name %}
                      {% when 'Color' %}
                        {% assign value_obj = variant.metafields.HENK.colour.value | first %}
                      {% when 'Upholstery material' %}
                        {% assign value_obj = variant.metafields.HENK.material.value | first %}
                      {% when 'Frame afwerking' %}
                        {% assign value_obj = variant.metafields.HENK.frame_finish.value %}
                      {% else %}
                        {% assign value_obj = variant[option.name] %}
                    {% endcase %}

                    {% assign option_value_id = value_obj.id | default: value_obj %}
                    {% if seen_values contains option_value_id %}
                      {% continue %}
                    {% endif %}
                    {% assign seen_values = seen_values | append: option_value_id | append: ',' %}

                    <div class="henk-labeled-input">
                      <label class="henk-label">
                        <input
                          class="henk-radio"
                          type="radio"
                          name="option-{{ option_index }}"
                          value="{{ value_obj.name | default: value_obj | escape }}"
                          {% if current_variant[option.name] == value_obj.name
                            or current_variant[option.name] == value_obj
                          %}
                            checked
                          {% endif %}
                          {% unless variant.available %}
                            disabled
                          {% endunless %}
                          data-variant-id="{{ variant.id }}"
                          data-featured-image="{{ variant.featured_image | image_url: width: 1134 }}"
                          data-sku="{{ variant.sku }}"
                          data-price="{{ variant.price }}"
                          {% if value_obj.name %}
                            data-material-name="{{ value_obj.name }}"
                          {% endif %}
                        >

                        <span
                          class="custom-swatch"
                          {% case option.name %}
                            {% when 'Color' %}
                              style="background-color: {{ value_obj.colour }};"
                            {% when 'Upholstery material' %}
                              {%- if value_obj.swatch %}
                                style="background-image:url({{ value_obj.swatch | image_url: width:44, height:44 }});"
                              {% endif %}
                            {% when 'Frame afwerking' %}
                              {%- if value_obj.swatch %}
                                style="background-image:url({{ value_obj.swatch | img_url: '100x100' }});"
                              {% endif %}
                          {% endcase %}
                        >
                        </span>

                        <span class="visually-hidden">{{ value_obj.name | default: value_obj }}</span>
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </fieldset>
              {% assign option_index = option_index | plus: 1 %}
            {% endfor %}

            <input type="text" name="quantity" min="1" value="1" class="henk-input">

            {% if current_variant.sku == blank %}
              {% render 'henk-info-box',
                variant: 'danger',
                title: 'NO SKU ASSIGNED',
                content: '<p>This product cannot be added to the cart yet. Please contact us.</p>',
                icon_name: 'danger'
              %}
            {% else %}
              <div class="henk-button-group henk-button-group--left">
                <a href="" class="henk-button henk-button--ghost">Bekijk in winkel</a>
                <input type="submit" value="Add to cart" class="henk-button henk-button--primary">
              </div>
            {% endif %}
          {% endform %}
        </div>
      </div>
    </div>
  </div>
</section>

<hr>

<section class="henk-section">
  <div class="henk-section__inner">
    <div class="henk-section__grid">
      <div class="henk-section__grid-item">
        <h2>Product details</h2>
        <p>{{ product.description }}</p>
      </div>
      <div class="henk-section__grid-item">
        <h2>Specifications</h2>
        <small id="ProductSKU">SKU: {{ current_variant.sku }}</small>
        <ul>
          {% for spec in product.metafields.specs.specifications %}
            <li>{{ spec }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const mainImage = document.getElementById('ProductFeaturedImage');
  const priceEl = document.getElementById('ProductPrice');
  const skuEl = document.getElementById('ProductSKU');
  const materialEl = document.getElementById('SelectedMaterial');
  const hiddenId = document.getElementById('SelectedVariantId');

  const variants = {{ product.variants | json }};
  const radios = document.querySelectorAll('.henk-radio');

  function formatPrice(cents) {
    const euros = Number(cents)/100;
    return new Intl.NumberFormat('nl-NL', { style:'currency', currency:'EUR' }).format(euros).replace(',00','');
  }

  function updateVariant() {
    const optionCount = {{ product.options.size }};
    const selected = [];
    for (let i=0; i<optionCount; i++) {
      const r = document.querySelector('input[name="option-'+i+'"]:checked');
      selected.push(r ? r.value : null);
    }

    const variant = variants.find(v => v.options.every((opt,i) => opt === selected[i]));
    if (!variant) return;

    hiddenId.value = variant.id;

    if (variant.featured_image && mainImage) mainImage.src = variant.featured_image.src;
    if (priceEl) priceEl.textContent = formatPrice(variant.price);
    if (skuEl) skuEl.textContent = variant.sku ? `SKU: ${variant.sku}` : 'SKU: â€”';
    if (materialEl) {
      const currentRadio = document.querySelector('input[data-variant-id="'+variant.id+'"]');
      if (currentRadio && currentRadio.dataset.materialName) {
        materialEl.textContent = currentRadio.dataset.materialName;
      }
    }

    // Update URL
    try {
      const url = new URL(window.location.href);
      url.searchParams.set('variant', variant.id);
      window.history.replaceState({}, '', url);
    } catch(e){}
  }

  radios.forEach(r => r.addEventListener('change', updateVariant));
});
</script>

{% schema %}
{
  "name": "t:general.product",
  "settings": [],
  "disabled_on": { "groups": ["header", "footer"] }
}
{% endschema %}
