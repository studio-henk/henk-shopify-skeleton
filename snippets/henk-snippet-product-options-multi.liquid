<!-- Options -->
{% for option in product.options_with_values %}
  <fieldset class="henk-fieldset">
    <legend class="henk-legend">{{ option.name }}</legend>
    <div class="options__container">
      {% for value in option.values %}
        {% comment %}Check if this value should have a swatch{% endcomment %}
        {% assign swatch = null %}
        {% for variant in product.variants %}
          {% for key in variant.metafields.HENK %}
            {% assign mf_value = key[1].value %}

            {% assign norm_value = value | downcase | replace: '-', ' ' | strip %}
            {% assign norm_mf = mf_value.name | downcase | replace: '-', ' ' | strip %}
            {% if norm_value == norm_mf %}
              {% assign swatch = mf_value.swatch | image_url %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if swatch %}
            {% break %}
          {% endif %}
        {% endfor %}
        <div class="henk-labeled-inputx">
          <label class="henk-labelx">
            <input
              class="henk-radio"
              type="radio"
              name="option-{{ option.name | downcase }}"
              value="{{ value }}"
              {% if current_variant.options[forloop.parentloop.index0] == value %}
                checked
              {% endif %}
            >

            <span class="custom-swatch">
              {% if swatch %}
                <img
                  src="{{ swatch | image_url: width: 44, height: 44 }}"
                  alt="{{ value }}"
                  width="44"
                  height="44"
                >
              {% else %}
                {{ value }}
              {% endif %}
            </span>
          </label>
        </div>
      {% endfor %}
    </div>
  </fieldset>
{% endfor %}

<!-- Hidden input for form -->
<input type="hidden" name="id" id="SelectedVariantId" value="{{ current_variant.id }}">
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- helpers (declare once) ---
    function formatPriceEUR(amountInCents) {
      // defensive parse
      const cents = Number(amountInCents);
      if (isNaN(cents)) return '';
      const euros = cents / 100;
      // format and remove trailing ",00"
      const formatted = new Intl.NumberFormat('nl-NL', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(euros);
      return formatted.replace(',00', '');
    }

    // --- cache elements ---
    const mainImage = document.getElementById('ProductFeaturedImage');
    const skuEl = document.getElementById('ProductSKU');
    const materialNameEl = document.getElementById('SelectedMaterial');
    const priceEl = document.getElementById('ProductPrice');

    // get all variant radio buttons (your class)
    const variantRadios = document.querySelectorAll('.henk-radio');

    if (!variantRadios.length) return;

    variantRadios.forEach((radio) => {
      radio.addEventListener('change', function () {
        if (!this.checked) return;

        // ðŸ”¥ FIX #1 â€” ensure only this one is checked
        variantRadios.forEach((r) => {
          r.checked = false;
          r.removeAttribute('checked');
        });

        this.checked = true;
        this.setAttribute('checked', '');

        // variant id
        const variantId = this.value;

        // image
        const imgUrl = this.dataset.featuredImage;
        if (imgUrl && mainImage) {
          // keep existing alt if provided on data-alt, otherwise leave as-is
          mainImage.src = imgUrl;
          if (this.dataset.featuredAlt) {
            mainImage.alt = this.dataset.featuredAlt;
          }
        }

        // SKU
        const sku = this.dataset.sku;
        if (skuEl) {
          skuEl.textContent = sku ? 'SKU: ' + sku : 'SKU: â€”';
        }

        // MATERIAL NAME (metafield friendly)
        const materialName = this.dataset.materialName || this.dataset.materialname || '';
        if (materialNameEl) {
          materialNameEl.textContent = materialName || '';
        }

        // PRICE
        const price = this.dataset.price; // expected in cents (integer)
        if (priceEl) {
          const formatted = formatPriceEUR(price);
          if (formatted) {
            priceEl.textContent = formatted;
          }
        }

        // update browser URL without reload
        try {
          const url = new URL(window.location.href);
          url.searchParams.set('variant', variantId);
          window.history.replaceState({}, '', url);
        } catch (e) {
          // fallback for older browsers
          // no-op
        }
      });
    });
  });
</script>
