{%- comment -%}
  henk-video.liquid
  Props:
    id: string (optional)
    src: string (required)
    poster: string (optional)
    autoplay: boolean (default: false)
    loop: boolean (default: true)
    cover: boolean (default: false)
    rounded: boolean (default: false)
    description: string (optional)
{%- endcomment -%}

{%- assign video_id = id | default: section.id | append: '-video' -%}

<div
  id="{{ video_id }}"
  class="
    henk-video-container
    {% if cover %} henk-video-container--cover{% endif %}
    {% if rounded %} henk-video-container--rounded{% endif %}
  "
>
  <video
    class="henk-video"
    src="{{ src }}"
    {% if poster %}
      poster="{{ poster }}"
    {% endif %}
    {% if autoplay %}
      autoplay muted playsinline
    {% else %}
      controls
    {% endif %}
    {% if loop %}
      loop
    {% endif %}
    preload="auto"
    aria-label="{{ description | escape }}"
  ></video>

  {% if autoplay %}
    <button
      type="button"
      class="henk-button henk-video-sound-toggle"
      aria-label="Toggle video sound"
    >
      <svg
        class="volume-x"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </svg>
      <svg
        class="volume-2"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      </svg>
    </button>
  {% endif %}
</div>
{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('{{ video_id }}');
    if (!container) return;

    const video = container.querySelector('video');
    const button = container.querySelector('.henk-video-sound-toggle');
    const svgMuted = button?.querySelector('.volume-x');
    const svgPlaying = button?.querySelector('.volume-2');

    if (button) {
      // Initial state
      svgMuted.style.display = 'block';
      svgPlaying.style.display = 'none';

      button.addEventListener('click', () => {
        video.muted = !video.muted;
        svgMuted.style.display = video.muted ? 'block' : 'none';
        svgPlaying.style.display = video.muted ? 'none' : 'block';
      });
    }

    // IntersectionObserver for autoplay/pause
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            if (video.autoplay) video.play().catch(() => {});
          } else {
            video.pause();
            if (button) {
              video.muted = true;
              svgMuted.style.display = 'block';
              svgPlaying.style.display = 'none';
            }
          }
        });
      },
      { threshold: 0.2 },
    );

    observer.observe(video);
  });
{% endjavascript %}
