{% comment %}
  This section is used in the product template to render product page with
  media, content, and add-to-cart form.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/product
{% endcomment %}

{% comment %} {{ product | json }} {% endcomment %}

{% assign current_variant = product.selected_or_first_available_variant %}
{% comment %} {{ current_variant | json }} {% endcomment %}

<section class="henk-section">
  <div class="henk-section__inner">
    <div class="henk-section__grid">
      <div class="henk-section__grid-item">
        <figure class="henk-card__image-container">
          <!-- {% assign current_variant = product.selected_or_first_available_variant %} -->
          {% comment %} {{ current_variant | json }} {% endcomment %}
          {% if current_variant.featured_image %}
            <img
              id="ProductFeaturedImage"
              class="henk-card__img"
              src="{{ current_variant.featured_image | image_url: width: 1134 }}"
              alt="{{ product.title }}"
              width="1134"
              height="1134"
            >
          {% else %}
            {{ 'image' | placeholder_svg_tag }}
          {% endif %}
        </figure>

        <h3>gallery</h3>
        <div class="product-images">
          {% for image in product.images %}
            {% comment %} {% render 'image', class: 'product-image', image: image %} {% endcomment %}
            {%- assign img_width = 1200 -%}
            {%- assign img_height = 1200 -%}

            <img
              src="{{ image | image_url: width: img_width }}"
              alt="{{ image.alt | escape | default: product.title }}"
              width="{{ img_width }}"
              height="{{ img_height }}"
              class="product-image"
              loading="lazy"
              {% if image.id %}
                data-image-id="{{ image.id }}"
              {% endif %}
            >
          {% endfor %}
        </div>
      </div>

      <div class="henk-section__grid-item">
        <div class="product-info">
          {% assign display_title = current_variant.name | default: product.title %}
          <h1 class="product__title">{{ display_title }}</h1>

          {% assign current_material = current_variant.metafields.HENK.material.value | first %}
          <p id="SelectedMaterial">{{ current_variant.title }}</p>

          {% comment %} {{ current_variant | json }} {% endcomment %}
          <p id="ProductPrice" class="product__price">
            {{ current_variant.price | money_without_trailing_zeros }}
          </p>

          <p class="product__description">{{ product.description }}</p>
        </div>

        <div class="product-form">
          {% form 'product', product %}
            {% comment %} {% assign current_variant = product.selected_or_first_available_variant %} {% endcomment %}
            {% comment %} {{ current_variant.options.size | json }} {% endcomment %}

            {% if product.variants.size == 1 %}
              {%- comment -%} NOTE: single variant, no options {%- endcomment -%}
              <input type="hidden" name="id" value="{{ current_variant.id }}">
            {% elsif product.variants.size > 1 %}
              {% comment %} NOTE: multiple variants, show options {% endcomment %}
              {% for option in product.options_with_values %}
                {% comment %} {{ option | json }} {% endcomment %}
                {% case option.name %}
                  {% when 'Color' %}
                    <fieldset class="henk-fieldset">
                      <legend class="henk-legend">Color</legend>
                      <div class="options__container">
                        {% for value in option.values %}
                          {% assign colorcode = value.swatch.color %}
                          {% assign colorname = value.name %}

                          <div class="henk-labeled-input">
                            <label class="henk-label">
                              <input
                                class="henk-radio"
                                type="radio"
                                name="id"
                                value="{{ value.variant.id }}"
                                title="{{ colorname }}"
                                data-featured-image="{{ value.variant.featured_image | image_url: width: 1134 }}"
                                data-material-name="{{ colorname }}"
                                data-sku="{{ value.variant.sku }}"
                                {% if value.variant.id == current_variant.id %}
                                  checked
                                {% endif %}
                              >

                              <span
                                class="custom-swatch"
                                style="background-color: {{ colorcode }};"
                              >
                              </span>

                              <span class="visually-hidden">
                                {{ colorname }}
                              </span>
                            </label>
                          </div>
                        {% endfor %}
                      </div>
                    </fieldset>

                  {% when 'Upholstery material' %}
                    {% comment %} {{ option | json }} {% endcomment %}

                    <fieldset class="henk-fieldset">
                      <legend class="henk-legend">Upholstery material</legend>

                      <div class="options__container">
                        {% assign option_index = forloop.index0 %}
                        <!-- index of current option (0-based) -->

                        {% for value in option.values %}
                          {% comment %}
                            Find 1 variant whose value for this option matches the option value
                          {% endcomment %}
                          {% assign matched_variant = null %}

                          {% for v in product.variants %}
                            {% if v.options[option_index] == value.name %}
                              {% assign matched_variant = v %}
                              {% break %}
                            {% endif %}
                          {% endfor %}

                          {% if matched_variant %}
                            {% assign material_data = matched_variant.metafields.HENK.material.value | first %}
                            {% comment %} {{ material_data.name }} {% endcomment %}
                            {% comment %} {{ material_data.color }} {% endcomment %}

                            {% assign swatch_gid = material_data.swatch %}
                            {% assign swatch_image = swatch_gid | image_url %}
                            <!-- <img src="{{ swatch_image | image_url: '44x44' }}" width="44" height="44"> -->

                            <div class="henk-labeled-input">
                              <label class="henk-label">
                                <input
                                  class="henk-radio"
                                  type="radio"
                                  name="id"
                                  value="{{ value.variant.id }}"
                                  title="{{ material_data.name }}"
                                  data-featured-image="{{ material_obj.variant.featured_image | image_url: width: 1134 }}"
                                  data-material-name="{{ material_name }}"
                                  data-sku="{{ value.variant.sku }}"
                                  {% if value.variant.id == current_variant.id %}
                                    checked
                                  {% endif %}
                                >

                                <span
                                  class="custom-swatch"
                                  style="background-color: {{ material_color_code }};"
                                >
                                  <img
                                    src="{{ swatch_image | image_url: width: 44, height: 44 }}"
                                    alt="{{ colorname }}"
                                    width="44"
                                    height="44"
                                  >
                                </span>

                                <span class="visually-hidden">
                                  {{ colorname }}
                                </span>
                              </label>
                            </div>
                          {% endif %}
                        {% endfor %}

                        {% comment %} {% for value in option.values %} {% endcomment %}
                        {% comment %}   <div class="henk-labeled-input"> {% endcomment %}
                        {% comment %}     <label class="henk-label"> {% endcomment %}
                        {% comment %}       <input {% endcomment %}
                        {% comment %}         class="henk-radio" {% endcomment %}
                        {% comment %}         type="radio" {% endcomment %}
                        {% comment %}         name="id" {% endcomment %}
                        {% comment %}         value="{{ value.variant.id }}" {% endcomment %}
                        {% comment %}         title="{{ material_name }}" {% endcomment %}
                        {% comment %}         data-featured-image="{{ material_obj.variant.featured_image | image_url: width: 1134 }}" {% endcomment %}
                        {% comment %}         data-material-name="{{ material_name }}" {% endcomment %}
                        {% comment %}         data-sku="{{ value.variant.sku }}" {% endcomment %}
                        {% comment %}         {% if value.variant.id == current_variant.id %} {% endcomment %}
                        {% comment %}           checked {% endcomment %}
                        {% comment %}         {% endif %} {% endcomment %}
                        {% comment %}       > {% endcomment %}
                        {% comment %}{% endcomment %}
                        {% comment %}       <span {% endcomment %}
                        {% comment %}         class="custom-swatch" {% endcomment %}
                        {% comment %}         style="background-color: {{ material_color_code }};" {% endcomment %}
                        {% comment %}       > {% endcomment %}
                        {% comment %}         <img {% endcomment %}
                        {% comment %}           src="{{ swatch_image | image_url: width: 44, height: 44 }}" {% endcomment %}
                        {% comment %}           alt="{{ colorname }}" {% endcomment %}
                        {% comment %}           width="44" {% endcomment %}
                        {% comment %}           height="44" {% endcomment %}
                        {% comment %}         > {% endcomment %}
                        {% comment %}       </span> {% endcomment %}
                        {% comment %}{% endcomment %}
                        {% comment %}       <span class="visually-hidden"> {% endcomment %}
                        {% comment %}         {{ colorname }} {% endcomment %}
                        {% comment %}       </span> {% endcomment %}
                        {% comment %}     </label> {% endcomment %}
                        {% comment %}   </div> {% endcomment %}
                        {% comment %}{% endcomment %}
                        {% comment %} {% endfor %} {% endcomment %}
                      </div>
                    </fieldset>
                  {% when 'Frame afwerking' %}
                    ???
                    <fieldset class="henk-fieldset">
                      <legend class="henk-legend">Frame afwerking</legend>

                      <div class="options__container">
                        {% assign seen_frames = '' | split: ',' %}

                        {% for variant in product.variants %}
                          {% assign frame_obj = variant.metafields.HENK.frame_finish.value %}
                          {% comment %} {{ frame_obj | json }} {% endcomment %}

                          {% if frame_obj %}
                            {% assign is_new = true %}
                            {% for seen_id in seen_frames %}
                              {% if seen_id == frame_obj.id %}
                                {% assign is_new = false %}
                              {% endif %}
                            {% endfor %}

                            {% if is_new %}
                              {% comment %} add id to seen_frames using concat and split {% endcomment %}
                              {% assign seen_frames = seen_frames | concat: frame_obj.id | split: ',' %}

                              <div class="henk-labeled-input henk-labeled-input--dir-verticalx">
                                <label class="henk-label">
                                  <input
                                    class="henk-radio"
                                    type="radio"
                                    name="id"
                                    value="{{ variant.id }}"
                                    {% if variant.id == current_variant.id %}
                                      checked
                                    {% endif %}
                                    {% unless variant.available %}
                                      disabled
                                    {% endunless %}
                                  >

                                  <span
                                    class="custom-swatch"
                                    style="background-image: url({{ frame_obj.swatch | img_url: '100x100' }});"
                                  ></span>

                                  <span class="visually-hidden">
                                    {{ frame_obj.name | default: variant.option2 }}
                                  </span>
                                </label>
                              </div>
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      </div>
                    </fieldset>

                  {% else %}
                    <!-- Default Shopify radios for all other options -->
                    <fieldset class="henk-fieldset">
                      <legend class="henk-legend">{{ option.name }}</legend>
                      <div class="options__container">
                        {% for value in option.values %}
                          {% assign variant_match = product.variants | where: option.name, value | first %}
                          <label class="henk-label">
                            <input
                              class="henk-radio"
                              type="radio"
                              name="option-{{ option.position }}"
                              value="{{ value }}"
                              {% if current_variant[option.name] == value %}
                                checked
                              {% endif %}
                              {% unless variant_match.available %}
                                disabled
                              {% endunless %}
                            >
                            {{ value }}
                          </label>
                        {% endfor %}
                      </div>
                    </fieldset>
                {% endcase %}
              {% endfor %}
            {% else %}
              more options?
            {% endif %}

            <input type="text" name="quantity" min="1" value="1" class="henk-input">

            {%- comment -%}check if has sku. if not, dont show buttons{%- endcomment -%}
            {% if current_variant.sku == blank %}
              {% render 'henk-info-box',
                variant: 'danger',
                title: 'NO SKU ASSIGNED',
                content: '<p>This product cannot be added to the cart yet. Please contact us.</p>',
                icon_name: 'danger'
              %}
            {% else %}
              <div class="henk-button-group henk-button-group--left">
                <a href="" class="henk-button henk-button--ghost">Bekijk in winkel</a>
                <input
                  type="submit"
                  value="Add to cart"
                  class="
                    henk-button
                    henk-button--primary
                  "
                >
                <!-- {{ form | payment_button }} -->
              </div>
            {% endif %}
          {% endform %}
        </div>
      </div>
    </div>
  </div>
</section>

<hr>
<section class="henk-section">
  <div class="henk-section__inner">
    <div class="henk-section__grid">
      <div class="henk-section__grid-item">
        <h2>Product details</h2>
        <p>{{ product.description }}</p>
      </div>

      <div class="henk-section__grid-item">
        <h2>Specifications</h2>
        <small id="ProductSKU">SKU: {{ current_variant.sku }}</small>
        <ul>
          {% for spec in product.metafields.specs.specifications %}
            <li>{{ spec }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</section>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- helpers (declare once) ---
    function formatPriceEUR(amountInCents) {
      // defensive parse
      const cents = Number(amountInCents);
      if (isNaN(cents)) return '';
      const euros = cents / 100;
      // format and remove trailing ",00"
      const formatted = new Intl.NumberFormat('nl-NL', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(euros);
      return formatted.replace(',00', '');
    }

    // --- cache elements ---
    const mainImage = document.getElementById('ProductFeaturedImage');
    const skuEl = document.getElementById('ProductSKU');
    const materialNameEl = document.getElementById('SelectedMaterial');
    const priceEl = document.getElementById('ProductPrice');

    // get all variant radio buttons (your class)
    const variantRadios = document.querySelectorAll('.henk-radio');

    if (!variantRadios.length) return;

    variantRadios.forEach((radio) => {
      radio.addEventListener('change', function () {
        if (!this.checked) return;

        // variant id
        const variantId = this.value;

        // image
        const imgUrl = this.dataset.featuredImage;
        if (imgUrl && mainImage) {
          // keep existing alt if provided on data-alt, otherwise leave as-is
          mainImage.src = imgUrl;
          if (this.dataset.featuredAlt) {
            mainImage.alt = this.dataset.featuredAlt;
          }
        }

        // SKU
        const sku = this.dataset.sku;
        if (skuEl) {
          skuEl.textContent = sku ? 'SKU: ' + sku : 'SKU: â€”';
        }

        // MATERIAL NAME (metafield friendly)
        const materialName = this.dataset.materialName || this.dataset.materialname || '';
        if (materialNameEl) {
          materialNameEl.textContent = materialName || '';
        }

        // PRICE
        const price = this.dataset.price; // expected in cents (integer)
        if (priceEl) {
          const formatted = formatPriceEUR(price);
          if (formatted) {
            priceEl.textContent = formatted;
          }
        }

        // update browser URL without reload
        try {
          const url = new URL(window.location.href);
          url.searchParams.set('variant', variantId);
          window.history.replaceState({}, '', url);
        } catch (e) {
          // fallback for older browsers
          // no-op
        }
      });
    });
  });
</script>
<style>
  .product-images {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
  }

  .product-image {
    margin: 0;
  }

  .henk-input[name='quantity'] {
    display: none;
  }

  .product__title {
    margin-top: 0;
  }

  .options__container {
    display: flex;
    gap: 1rem;

    .henk-label {
      position: relative;
    }
  }

  .henk-radio {
    margin: 0;
  }

  .henk-labeled-input {
    margin-bottom: 0;
  }

  .options__container .henk-radio {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    width: 44px;
    height: 44px;
  }

  .custom-swatch {
    display: block;
    width: 44px;
    height: 44px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  input[type='radio']:checked + .custom-swatch {
    border: 4px solid var(--color-blue-40);
  }
</style>
{% schema %}
{
  "name": "t:general.product",
  "settings": [],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
